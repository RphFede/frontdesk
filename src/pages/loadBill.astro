---
import BaseLayout from "../layouts/BaseLayout.astro"
---
<BaseLayout>
<section id="loadbill" class="view">

  <h1>Cargar Factura</h1>

<div class="view-container">  
  <div class="form-section">
    <form id="loadbill-form">
      <!-- Informaci√≥n del Proveedor -->
      <fieldset>
        <legend>üè¢ Informaci√≥n de proveedor</legend>
        <div class="row">
          <div class="group">
            <label for="supplier">Raz√≥n Social *</label>
            <select id="supplier" required>
              <option value="">Seleccionar proveedor...</option>
              <option value="1">Constructora ABC S.A.</option>
              <option value="2">Suministros Municipales Ltda.</option>
              <option value="3">Servicios Generales SRL</option>
              <option value="4">TechSolutions SpA</option>
              <option value="5">Mantenimiento Integral Ltda.</option>
            </select>
          </div>
          <div class="group">
            <label for="supplier-rut">CUIT</label>
            <input type="text" id="supplier-rut" placeholder="12.345.678-9" readonly>
          </div>
          <div class="group">
            <label for="add-supplier">Agregar Nuevo</label>
            <button type="button" id="add-supplier">+</button>
          </div>          
        </div>
      </fieldset>

      <!-- Informaci√≥n de la Factura -->
      <fieldset>
        <legend>üìÑ Datos de factura</legend>
        <div class="row">
          <div class="group">
            <label for="classification">Clasificaci√≥n *</label>
            <select id="classification" required>
              <option value="">Seleccionar clasificaci√≥n...</option>
              <option value="consumer goods">Consumo</option>
              <option value="services">Servicio</option>
              <option value="capital goods">Capital</option>
            </select>
          </div>
          <div class="group">
            <label for="invoice-number">Nro. Factura *</label>
            <input type="text" id="invoice-number" placeholder="Ej: B-00001-01234" required>
          </div>
          <div class="group">
            <label for="invoice-date">Fecha de Emisi√≥n *</label>
            <input type="date" id="invoice-date" required>
          </div>
        </div>
        
        <div class="row">
          <div class="group">
            <label for="description">Descripci√≥n *</label>
            <textarea id="description" placeholder="Descripci√≥n de bien o servicio..." required></textarea>
          </div>
        </div>
      </fieldset>

      <!-- Botones de Acci√≥n -->
      <div class="actions">
        <button type="button" class="clean" id="clean-btn">‚ùå Limpiar valores</button>
        <button type="submit" class="submit" id="submit-btn">‚úÖ Registrar factura</button>
      </div>
    </form>
  </div>
</div>
</section>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loadbill-form');

    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const supplierSelect = document.getElementById('supplier');
      const supplierName = supplierSelect instanceof HTMLSelectElement ? supplierSelect.options[supplierSelect.selectedIndex].text : '';
      const supplierRutElement = document.getElementById('supplier-rut') as HTMLInputElement;
      const supplierRut = supplierRutElement?.value || '';
      const classificationElement = document.getElementById('classification') as HTMLSelectElement;
      const classification = classificationElement?.value || '';
      const invoiceNumberElement = document.getElementById('invoice-number') as HTMLInputElement;
      const invoiceNumber = invoiceNumberElement?.value || '';
      const invoiceDateElement = document.getElementById('invoice-date') as HTMLInputElement;
      const invoiceDate = invoiceDateElement?.value || '';
      const descriptionElement = document.getElementById('description') as HTMLTextAreaElement;
      const description = descriptionElement?.value || '';

      const invoiceData = {
        supplier: supplierName,
        supplier_rut: supplierRut,
        classification,
        invoice_number: invoiceNumber,
        invoice_date: invoiceDate,
        description
      };

      try {
        const response = await fetch('http://localhost:5000/invoices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        if (!response.ok) {
          const error = await response.json();
          alert('‚ùå Error: ' + error.error);
        } else {
          alert('‚úÖ Factura registrada correctamente');
(form as HTMLFormElement).reset();
          (document.getElementById('supplier-rut') as HTMLInputElement).value = '';
        }
      } catch (error) {
        alert('üö® Fallo al enviar: ' + error.message);
      }
    });

    // Opcional: actualiza el RUT cuando cambias de proveedor
    const suppliers = {
      '1': '12.345.678-9',
      '2': '98.765.432-1',
      '3': '55.666.777-8',
      '4': '11.222.333-4',
      '5': '77.888.999-0'
    };

    document.getElementById('supplier')?.addEventListener('change', function () {
      const rut = suppliers[(this as HTMLSelectElement).value] || '';
      (document.getElementById('supplier-rut') as HTMLInputElement).value = rut;
    });
  });
</script>

<style lang="stylus">

.form-section
  background var(--bg-secondary)
  border-radius 12px
  border 1px solid var(--border-color)
  padding 2rem
  box-shadow 0 2px 8px rgba(0, 0, 0, 0.1)
  
fieldset
  border 1px solid var(--border-color)
  border-radius 8px
  padding 1.5rem
  margin-bottom 2rem
  background transparent
  
  legend
    padding 0 1rem
    color var(--text-primary)
    font-weight 600
    font-size 1.1rem

.row
  display flex
  gap .5rem
  margin-bottom 1.5rem
  
  @media (max-width: 768px)
    flex-direction column
    gap 1rem
  
.group
  flex 1
  
  label
    display block
    margin-bottom 0.5rem
    color var(--text-primary)
    font-weight 500
    font-size 0.9rem
  
  input, select, textarea
    width 100%
    padding 0.75rem
    border 1px solid var(--border-color)
    border-radius 6px
    background var(--bg-input)
    color var(--text-primary)
    font-size 1rem
    transition border-color 0.2s ease
    
    &:focus
      outline none
      border-color var(--accent-primary)
      box-shadow 0 0 0 2px rgba(59, 130, 246, 0.1)
    
    &:required:invalid
      border-color var(--error-color)
    
    &[readonly]
      background var(--bg-disabled)
      color var(--text-secondary)
      cursor not-allowed
  
  textarea
    min-height 100px
    resize vertical
    font-family inherit

.form-actions
  display flex
  gap 1rem
  justify-content flex-end
  padding-top 2rem
  border-top 1px solid var(--border-color)
  
  @media (max-width: 768px)
    flex-direction column
  
  button
    padding 0.75rem 2rem
    border none
    border-radius 6px
    font-weight 600
    font-size 1rem
    cursor pointer
    transition all 0.2s ease
      
      &:hover
        background var(--bg-hover)
    
    &.clean
      background var(--accent-primary)
      color white
      
      &:hover
        background var(--accent-hover)
        transform translateY(-1px)
    
    &.submit
      background var(--success-color)
      color white
      
      &:hover
        background #5a8a5a
        transform translateY(-1px)
</style>